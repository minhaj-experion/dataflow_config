# API Store Driver Documentation

The **API Store Driver** is a powerful, configurable connector designed for ingesting data from **external APIs**, both **REST** and **GraphQL**, into your data processing pipeline. With support for various **authentication mechanisms**, **pagination types**, **dynamic field selection**, and **GraphQL queries**, it helps streamline data ingestion workflows from third-party services.

## Configuration Fields Breakdown


| Argument                              | Type         | Mandatory               | Default Value | Description |
|---------------------------------------|--------------|--------------------------|----------------|-------------|
| `from.store.url`                      | `str`        | Yes                      | —              | The base API endpoint to fetch data from. Can be REST or GraphQL. |
| `from.store.authentication_type`      | `str`        | Yes                      | —              | Defines the auth method used for the API (e.g., bearer, basic, oauth2, none). |
| `from.store.auth_config`              | `dict`       | Yes, if auth is used     | —              | Contains auth-specific keys like tokens or credentials. Structure depends on the authentication type. |
| `from.store.graphql`                  | `bool`       | No                       | `false`        | Boolean flag to enable GraphQL support. Set `true` to treat the endpoint as a GraphQL server. |
| `from.store.graphql_config.query`     | `str`        | Yes, if `graphql = true` | —              | The actual GraphQL query string to fetch data. |
| `from.store.graphql_config.variables` | `dict`       | No                       | `None`         | A map of dynamic variables passed into the GraphQL query. |
| `from.store.graphql_config.headers`   | `dict`       | No                       | `None`         | Any custom headers required for GraphQL requests. |
| `from.data_path`                      | `str`        | Yes                      | —              | JSONPath-style pointer to extract the main data array from a nested API response. |
| `from.selected_columns`               | `dict`       | No                       | `None`         | Maps output field names to paths within each record (dot notation supported). |
| `from.pagination.active`              | `bool`/`str` | No                       | `false`        | Enables pagination handling if the API paginates responses. |
| `from.pagination.type`                | `str`        | Yes, if pagination active| —              | Type of pagination: `page`, `offset`, or `next_page`. |
| `from.pagination.page_param`          | `str`        | Yes, if `type = page`    | —              | Query parameter name used for page number. |
| `from.pagination.size_param`          | `str`        | No                       | `None`         | Name of the parameter for setting results per page or limit. |
| `from.pagination.size`                | `int`        | No                       | `None`         | Number of results per page/offset call. |
| `from.pagination.start`               | `int`        | No                       | `0`            | Starting page number or offset value. |
| `from.pagination.end`                 | `int`        | No                       | `None`         | Ending page number or offset value. |
| `from.pagination.offset_param`        | `str`        | Yes, if `type = offset`  | —              | Name of the query parameter used to define offset. |
| `from.pagination.limit_param`         | `str`        | No                       | `None`         | Parameter for limiting result count per call. |
| `from.pagination.next_page_path`      | `str`        | Yes, if `type = next_page` | —            | Dot path in the response pointing to the URL for the next page (for cursor-based APIs). |
| `from.pagination.max_pages`           | `int`        | No                       | `None`         | Max number of pages to fetch before stopping. Useful for large datasets or controlling costs. |


## Authentication Methods

APIs often require authentication. This section provides examples of all supported methods and when to use them:

### 1. None  
For public APIs without any authentication requirements.

```yaml
authentication_type: none
```

Use when consuming open data or demo endpoints.

---

### 2. Bearer Token  
A secure token is sent in the Authorization header.

```yaml
authentication_type: bearer
auth_config:
  token: "your_token_here"
```

Best for OAuth2-protected APIs where you manually generate the token.

---

### 3. Basic Auth  
Uses a username-password combo base64-encoded into the header.

```yaml
authentication_type: basic
auth_config:
  username: "admin"
  password: "secret"
```

Ensure you use HTTPS with basic auth to avoid credential leaks.

---

### 4. OAuth2 (Client Credentials Flow)  
The driver first calls a token endpoint to obtain a bearer token.

```yaml
authentication_type: oauth2
auth_config:
  token_url: "https://auth.service.com/oauth2/token"
  client_id: "client_id"
  client_secret: "client_secret"
  body:
    - key: grant_type
      value: client_credentials
    - key: scope
      value: read
```

Best for machine-to-machine communication with secure access tokens.

---

### 5. OAuth1  
Often used by older APIs (e.g., Twitter API v1.1).

```yaml
authentication_type: oauth1
auth_config:
  consumer_key: "abc"
  consumer_secret: "xyz"
  resource_owner_key: "123"
  resource_owner_secret: "456"
```

Uses signatures instead of tokens—complex but secure.

---

### 6. API Key in Header or Query Params  
Send static API keys either in the header or URL.

```yaml
authentication_type: apikey
auth_config:
  key: "your_api_key"
  key_name: "X-API-Key"
  in: "header"  # or "query"
```

Avoid exposing keys in client-side code or unsecured URLs.

---

### 7. Custom Headers  
When the API uses a proprietary or non-standard auth mechanism.

```yaml
authentication_type: header
auth_config:
  headers:
    X-Access-Token: "abc123"
    Accept: "application/json"
```

---

### 8. URL Parameters  
Pass credentials or tokens directly in the URL.

```yaml
authentication_type: params
auth_config:
  params:
    token: "abc"
```

---

### 9. Body Parameters  
Sends credentials in the body of a POST request (e.g., form login).

```yaml
authentication_type: body
auth_config:
  body:
    username: "demo"
    password: "demo123"
```


## Pagination Strategies

Efficient API data extraction often requires handling paginated results. The driver supports three main types:

---

### Page-Based Pagination  
Use when the API accepts page number and size.

```yaml
type: page
page_param: "page"
size_param: "limit"
start: 1
end: 5
```

Suitable for standard REST APIs like GitHub, Airtable, etc.

---

### Offset-Based Pagination  
Use offset values to fetch sequential chunks.

```yaml
type: offset
offset_param: "offset"
limit_param: "limit"
start: 0
end: 1000
```

Ideal for APIs like Spotify, where records are pulled in batches.

---

### Cursor or Link-Based (Next Page URL)  
For APIs that return a "next" URL in the response body.

```yaml
type: next_page
next_page_path: "links.next"
max_pages: 10
```

Common in GraphQL APIs and some REST APIs like Stripe.


## GraphQL Support

When using GraphQL APIs, the driver can send queries and dynamically parse structured responses.

```yaml
graphql: true
graphql_config:
  query: |
    query ($limit: Int!) {
      users(limit: $limit) {
        id
        name
        email
      }
    }
  variables:
    limit: 10
  headers:
    Content-Type: application/json
```

Don't forget to set `data_path` based on the JSON response structure.

## `selected_columns`

The `selected_columns` field is used to **extract**, **flatten**, and optionally **rename** specific fields from each record in an API response. This allows for streamlined, structured, and relevant data extraction tailored to your needs.

### Key Features

| Feature                  | Description                                                                 |
|--------------------------|-----------------------------------------------------------------------------|
| **Field Mapping**        | Rename fields from the source API response to custom field names.           |
| **Nested Access**        | Use dot notation to access deeply nested fields within JSON structures.     |
| **Flattening**           | Converts nested structures into a flat format for easier data handling.     |
| **Flexible Extraction**  | Compatible with both REST and GraphQL responses.                            |
| **Optional Type Casting**| Define the expected data type for each field (planned/custom extension).    |

---

### Example

#### Sample API Response

```json
{
  "user": {
    "id": 101,
    "name": "Alice",
    "location": {
      "region": "EMEA"
    }
  },
  "status": "active"
}
```

#### Configuration

```yaml
selected_columns:
  user_id: "user.id"
  name: "user.name"
  region: "user.location.region"
  status: "status"
```

#### Output

```json
{
  "user_id": 101,
  "name": "Alice",
  "region": "EMEA",
  "status": "active"
}
```

---

### Using with `data_path`

If the relevant records are nested under a wrapper key (e.g., `data.users`), the `data_path` field can be used to specify the path to the list of records. The `selected_columns` mapping is then applied to each item in that list.

#### Example

##### API Response

```json
{
  "data": {
    "users": [
      {
        "id": 1,
        "profile": {
          "fullName": "John Doe"
        }
      }
    ]
  }
}
```

##### Configuration

```yaml
data_path: "data.users"
selected_columns:
  id: "id"
  name: "profile.fullName"
```

##### Output

```json
{
  "id": 1,
  "name": "John Doe"
}
```

## Example: Full Configuration for REST API

```yaml
from:
  store:
    url: "https://api.openweathermap.org/data/2.5/weather"
    authentication_type: apikey
    auth_config:
      key: "your_key"
      key_name: "appid"
      in: "query"
  data_path: "main"
  selected_columns:
    temp: "temp"
    pressure: "pressure"
    humidity: "humidity"
```
