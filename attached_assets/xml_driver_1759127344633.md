# XML Ingestion

### Description

The `PythonXmlDriver` class provides an interface to read and write XML data using XPath-based extraction rules.
It leverages `lxml` for fast, robust XML parsing and supports configuration-driven transformation of XML files into structured tabular formats such as  DataFrames.

The driver supports selective field extraction and is driven by a flexible YAML-based configuration for both reading and writing XML files.

---

### How to Use in YAML Config

The YAML configuration defines how to read and write XML files using the following blocks:

### YAML Example:

```yaml
mappings:
  from:
      store:
        type: local
        input_path: <source directory path>

      data_format:
          type: xml
          file_encoding: <optional encoding>  
          encoding_error_handling: <optional error handling>  
          xpath: <XPath expression>         
          elems_only: <true/false>          
          attrs_only: <true/false>
          namespace: <expression>  
          parser: <parser engine>  
          compression: <compression type>  
          selected_columns:
            <new_column_name>: <xml_tag_name>  

        entity:
          include:
            - <entity patterns to include>  # Example: "input*"
          

      to:
        store:
          type: local
          output_path: <destination directory path> 

        data_format:
          type: xml
          file_encoding: <encoding>  # Example: "utf-8"
          root_name: <root element name>  # Example: "entries"
          row_name: <row element name>  # Example: "entry"
          index: <true/false>
          na_rep: <string for NA values>  # Example: "NA"
          attr_cols: <attribute column list>  # Optional
          elem_cols: <element column list>  # Optional
          xml_declaration: <true/false>
          pretty_print: <true/false>
          parser: <parser engine>  # Example: "lxml"
          compression: <compression type>  # Example: "gzip"

        entity:
          name: <output name>  # Example: "output_{${entity}$}
```

---

### Read Configuration

| Argument                     | Type     | Mandatory | Default Value | Description                                                                                           |
|------------------------------|----------|-----------|----------------|--------------------------------------------------------------------------------------------------------|
| `store.type`                | `str`    | Yes        | `local`         | Type of storage backend. Accepts values like `local`, `s3`, `gcs`. Used to locate the input XML files. |
| `store.path`                | `str`    | Yes        | -              | Path to the directory or file containing the XML files to ingest.                                      |
| `data_format.type`          | `str`    | Yes        | `xml`           | Specifies the file format. Should be `xml` for XML ingestion.                                          |
| `data_format.xpath`         | `str`    | Yes        | `.//*`          | XPath expression used to locate and extract repeated XML elements (e.g., `.//ettevotja`). This defines the rows/records in the resulting DataFrame. |
| `data_format.elems_only`    | `bool`   | No         | `false`         | If `true`, only XML element values (tags) are parsed and attributes are ignored.                       |
| `data_format.attrs_only`    | `bool`   | No         | `false`         | If `true`, only attributes of XML elements are extracted. When both `elems_only` and `attrs_only` are `false`, both values and attributes are considered. |
| `data_format.encoding`      | `str`    | No         | `utf-8`         | File encoding for reading XML files. Typically `utf-8`.                                                 |
| `data_format.parser`        | `str`    | No         | `lxml`          | Parser engine to use. Recommended: `lxml` for better performance and XPath support.                    |
| `data_format.compression`   | `str`    | No         | `infer`         | Compression type. Supported values: `gzip`, `bz2`, `zip`, `xz`, or `infer` to auto-detect from file extension. |
| `entity.include`            | `list`   | No         | `*all`          | List of patterns to include input files. Uses glob patterns or regex (e.g., `["*"]`, `["company*"]`).  |
| `entity.exclude`            | `list`   | No         | `[]`            | List of patterns to exclude input files. Useful to skip test files or archives.                        |
| `entity.selected_columns`   | `dict`   | No         | `{}`            | A mapping of output column names to XML tag names. It allows renaming and selective parsing. Example:<br>`company_name: "nimi"`<br>`registry_code: "ariregistri_kood"`<br>`status_code: "ettevotja_staatus"` |

---
### Write Configuration

| Argument                      | Type     | Mandatory | Default Value | Description                                                                                               |
|-------------------------------|----------|-----------|----------------|------------------------------------------------------------------------------------------------------------|
| `store.type`                 | `str`    | Yes        | `local`         | Type of storage backend to write to. Supported options: `local`, `s3`, `gcs`.                              |
| `store.path`                 | `str`    | Yes        | -              | Directory or file path where the output XML will be saved. Can be a full file path or a directory.        |
| `data_format.type`           | `str`    | Yes        | `xml`           | Specifies the output format. For XML export, set this to `xml`.                                           |
| `data_format.root_tag`       | `str`    | No         | `data`          | Name of the root element in the XML file that wraps all records.                                          |
| `data_format.record_tag`     | `str`    | No         | `record`        | XML tag used for each individual record (row) in the DataFrame.                                           |
| `data_format.encoding`       | `str`    | No         | `utf-8`         | Encoding used when writing the XML file. Common values include `utf-8` and `utf-16`.                      |
| `data_format.pretty_print`   | `bool`   | No         | `true`          | If `true`, the output XML will be indented and formatted with line breaks.                                |
| `data_format.include_attrs`  | `bool`   | No         | `false`         | If `true`, fields will be written as attributes inside the XML tags instead of child elements.            |
| `data_format.compression`    | `str`    | No         | `none`          | Optional compression type. Supported values: `none`, `gzip`, `bz2`, `zip`, `xz`.                          |
| `entity.file_naming`         | `str`    | No         | `default.xml`   | Name of the output XML file. Can be templated using placeholders like `{date}` or `{entity}`.            |
| `entity.selected_columns`    | `list`   | No         | `*all`          | List of columns from the DataFrame to include in the output XML. If not specified, all columns are used.  |

---

## Functionality

### Ingestion Flow

- **Read XML**:  
  The pipeline reads XML files using XPath expressions and the `lxml` parser. It allows filtering of elements or attributes and supports selective extraction of fields based on `selected_columns`.

- **Transform Data**:  
  Extracted XML data is converted into a structured format (DataFrame-like), enabling transformation, enrichment, or cleaning based on configuration.

- **Write XML**:  
  The resulting data is written back into an XML file with a configurable root and row tag structure, preserving schema expectations for downstream use. It supports XML declaration, pretty-printing, and selective inclusion of fields as attributes or elements.


